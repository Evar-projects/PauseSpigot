From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Permisos <ido@terrorist.services>
Date: Wed, 3 Aug 2022 20:05:45 -0300
Subject: [PATCH] Use a Queue for Queueing Commands


diff --git a/src/main/java/net/minecraft/server/DedicatedServer.java b/src/main/java/net/minecraft/server/DedicatedServer.java
index 2519d4ca1bb09d76caa2373164625aa6b692176e..7fe1c712c43e08fcdb4101eb10607249cfc3263e 100644
--- a/src/main/java/net/minecraft/server/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/DedicatedServer.java
@@ -29,7 +29,8 @@ import org.bukkit.event.server.RemoteServerCommandEvent;
 public class DedicatedServer extends MinecraftServer implements IMinecraftServer {
 
     private static final Logger LOGGER = LogManager.getLogger();
-    private final List<ServerCommand> l = Collections.synchronizedList(Lists.<ServerCommand>newArrayList()); // CraftBukkit - fix decompile error
+    private final java.util.Queue<ServerCommand> l = new java.util.concurrent.ConcurrentLinkedQueue<>(); // CraftBukkit - fix decompile error
+    private final java.util.Queue<ServerCommand> serverCommandQueue = l; // Paper - use a proper queue // PauseSpigot - OBF HELPER
     private RemoteStatusListener m;
     private RemoteControlListener n;
     public PropertyManager propertyManager;
@@ -437,9 +438,10 @@ public class DedicatedServer extends MinecraftServer implements IMinecraftServer
 
     public void aO() {
         SpigotTimings.serverCommandTimer.startTiming(); // Spigot
-        while (!this.l.isEmpty()) {
-            ServerCommand servercommand = (ServerCommand) this.l.remove(0);
-
+        // Paper start - use proper queue
+        ServerCommand servercommand;
+        while ((servercommand = this.serverCommandQueue.poll()) != null) {
+            // Paper end
             // CraftBukkit start - ServerCommand for preprocessing
             ServerCommandEvent event = new ServerCommandEvent(console, servercommand.command);
             server.getPluginManager().callEvent(event);
